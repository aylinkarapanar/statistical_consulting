---
title: "Model Spesifications"
author: "Atakan_Akgun, Aylin Karapanar"
date: "`r Sys.Date()`"
output: html_notebook
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
# Essential libraries
library(corrplot)
library(ggeffects)
library(ggplot2)
library(DHARMa)
library(glmmTMB)
library(dplyr)
library(lubridate)
library(emmeans)
library(tidyverse)
library(performance)
```

## 1. Data Import and Preparation

```{r}
df <- read.csv("./data/Mock_Mosquito_MixedEffects_w_slopes_Dataset.csv")

```

```{r}
head(df)
```

## 2. Model Specification

### Defining Random Effects

We start by first defining the random effects part. There are two random effects defined in our model, one for the nested structure in our data and the other for the mosquito species. By defining random intercepts in m1 model, we assume that different cities have different baseline abundance levels, different sites within the same city have different baseline abundance, and different mosquito species have different baseline abundance levels. However, the slopes remain consistent meaning all cities and species respond to green coverage the same way.


```{r}
m1_baseline <- glmmTMB(
  Mosquito_abundance ~ Green_area_coverage * Trap_type +
                       Temperature * Relative_humidity +
                       Host_abundance * Prey_abundance +
                       Blue_area_coverage +
                       factor(Month) +
                       (1 | City / Location.Site) +      # nested random effects
                       (1 | Mosquito_species),           # random intercept by species
  family = nbinom2(),
  data = df,
  REML = TRUE
)

summary(m1_baseline)

baseline_aic <- AIC(m1_baseline)
cat("Baseline AIC:", baseline_aic, "\n")
```

In the second model, we consider random slopes for green levels in the cities, meaning that the effect of urban green differs per city.

```{r}
m2_city_green <- glmmTMB(
  Mosquito_abundance ~ Green_area_coverage * Trap_type +
                       Temperature * Relative_humidity +
                       Host_abundance * Prey_abundance +
                       Blue_area_coverage +
                       factor(Month) +
                      (1 + Green_area_coverage | City) +          # City random intercept + slope
                      (1 | Location.Site:City) +        
                      (1 | Mosquito_species),
  family = nbinom2(),
  data = df,
  REML =TRUE
)


# Check convergence
check_convergence(m2_city_green)
m2_city_green$sdr$pdHess

cat("AIC difference:", AIC(m2_city_green) - baseline_aic, "\n")

lrt_m2 <- anova(m1_baseline, m2_city_green)$Chisq[2]

p_m2 <- 0.5 * pchisq(lrt_m2, df = 2, lower.tail = FALSE) + 
           0.5 * pchisq(lrt_m2, df = 1, lower.tail = FALSE)
cat("p-value:", p_m2, "\n")

```

AIC difference is positive and the $H_0: \text{Cities do not differ in how urban green level affects mosquito abundance}$ is not rejected (p>0.05), the random slope of urban green level is not significant.


```{r}
m3_city_temp <- glmmTMB(
  Mosquito_abundance ~ Green_area_coverage * Trap_type +
                       Temperature * Relative_humidity +
                       Host_abundance * Prey_abundance +
                       Blue_area_coverage +
                       factor(Month) +
                      (1 + Temperature | City) +      
                      (1 | Location.Site:City) +        
                      (1 | Mosquito_species),
  family = nbinom2(),
  data = df,
  REML = TRUE
)

# Check convergence
check_convergence(m3_city_temp)
m3_city_temp$sdr$pdHess

cat("AIC difference:", AIC(m3_city_temp) - baseline_aic, "\n")

lrt_m3 <- anova(m1_baseline, m3_city_temp)$Chisq[2]

p_m3 <- 0.5 * pchisq(lrt_m3, df = 2, lower.tail = FALSE) +
        0.5 * pchisq(lrt_m3, df = 1, lower.tail = FALSE)
cat("p-value for Temp slope:", p_m3, "\n")
```
AIC difference is positive and the $H_0: \text{Cities do not differ in how temperature affects mosquito abundance}$ is retained (p>0.05), the random slope of temperature is not significant.

```{r}
m4_both_slopes <- glmmTMB(
  Mosquito_abundance ~ Green_area_coverage * Trap_type +
                       Temperature * Relative_humidity +
                       Host_abundance * Prey_abundance +
                       Blue_area_coverage +
                       factor(Month) +
                       (1 + Green_area_coverage + Temperature | City) +
                       (1 | Location.Site:City) +
                       (1 | Mosquito_species),
  family = nbinom2(),
  data = df,
  REML = TRUE
)

# Check convergence
check_convergence(m4_both_slopes)
m4_both_slopes$sdr$pdHess

# Compare m2 -> m4 (does adding temperature slope to m2 improve fit?)
lrt_m2_m4 <- anova(m2_city_green, m4_both_slopes)$Chisq[2]
cat("LRT stat (m2 -> m4):", lrt_m2_m4, "\n")
p_m2_m4 <- 0.5 * pchisq(lrt_m2_m4, df = 2, lower.tail = FALSE) + 
           0.5 * pchisq(lrt_m2_m4, df = 1, lower.tail = FALSE)
cat("p-value (m2 -> m4):", p_m2_m4, "\n")

# Compare m3 -> m4 (does adding Green slope to m3 improve fit?)
lrt_m3_m4 <- anova(m3_city_temp, m4_both_slopes)$Chisq[2]
cat("LRT stat (m3 -> m4):", lrt_m3_m4, "\n")
p_m3_m4 <- 0.5 * pchisq(lrt_m3_m4, df = 2, lower.tail = FALSE) + 
           0.5 * pchisq(lrt_m3_m4, df = 1, lower.tail = FALSE)
cat("p-value (m3 -> m4):", p_m3_m4, "\n")

# Compare all models by AIC 
models <- list(m1_baseline = m1_baseline, m2 = m2_city_green, m3 = m3_city_temp, m4 = m4_both_slopes)
aic_tab <- data.frame(
  model = names(models),
  AIC = sapply(models, AIC),
  pdHess = sapply(models, function(m) { if (is.null(m$sdr)) NA else m$sdr$pdHess })
)
aic_tab <- aic_tab %>% arrange(AIC)
print(aic_tab)
```

Across the models tested, the lowest AIC value was tested was achieved by model 2, for the remainder of the model selection procedure we will use the random effects defined in model 1. Now, we will focus on getting a more parsimonious fixed effects part by removing interaction terms in a step wise manner.


```{r}
m_full <- glmmTMB(
  Mosquito_abundance ~ Green_area_coverage * Trap_type +
                       Temperature * Relative_humidity +
                       Host_abundance * Prey_abundance +
                       Blue_area_coverage +
                       factor(Month) +
                       (1 | City / Location.Site) +      # nested random effects
                       (1 | Mosquito_species), 
  family = nbinom2(),
  data = df,
  REML = FALSE  # ML for fixed effects comparison
)

summary(m_full)
```

We start by removing the least significant interaction term which is Temperature:Relative_humidity . 
```{r}
m_wo_temp_hum <- glmmTMB(
  Mosquito_abundance ~ Green_area_coverage * Trap_type +
                       Temperature + Relative_humidity +
                       Host_abundance * Prey_abundance +
                       Blue_area_coverage +
                       factor(Month) +
                       (1 | City / Location.Site) +      # nested random effects
                       (1 | Mosquito_species), 
  family = nbinom2(),
  data = df,
  REML = FALSE  # ML for fixed effects comparison
)

summary(m_wo_temp_hum)
anova(m_full, m_wo_temp_hum)
```
Removing the Temp x Humidity interaction does not significantly worsen model fit, then the interaction is not needed. We move on to the next interaction.

```{r}
m_wo_host_prey <- glmmTMB(
  Mosquito_abundance ~ Green_area_coverage * Trap_type +
                       Temperature + Relative_humidity +
                       Host_abundance + Prey_abundance +
                       Blue_area_coverage +
                       factor(Month) +
                       (1 | City / Location.Site) +      # nested random effects
                       (1 | Mosquito_species), 
  family = nbinom2(),
  data = df,
  REML = FALSE  # ML for fixed effects comparison
)

summary(m_wo_host_prey)
anova(m_wo_temp_hum, m_wo_host_prey)
```
Removing the Host × Prey interaction does not significantly worsen model fit, then the interaction is not needed. The last interaction is significant, therefore we move to the main effects.

```{r}
m_wo_blue <- glmmTMB(
  Mosquito_abundance ~ Green_area_coverage * Trap_type +
                       Temperature + Relative_humidity +
                       Host_abundance + Prey_abundance +
                       factor(Month) +  # Remove Blue
                       (1 | City / Location.Site) +
                       (1 | Mosquito_species), 
  family = nbinom2(),
  data = df,
  REML = FALSE
)

summary(m_wo_blue)
anova(m_wo_host_prey, m_wo_blue)
```
Month showes mixed significance, so we will try removing it and compare the model fits.

```{r}
m_wo_month <- glmmTMB(
  Mosquito_abundance ~ Green_area_coverage * Trap_type +
                       Temperature + Relative_humidity +
                       Host_abundance + Prey_abundance +
                       # Remove Month entirely
                       (1 | City / Location.Site) +
                       (1 | Mosquito_species), 
  family = nbinom2(),
  data = df,
  REML = FALSE
)

anova(m_wo_blue, m_wo_month)
```
Removing the month worsens the fit, so our final model is:

```{r}
m_final <- glmmTMB(
  Mosquito_abundance ~ Green_area_coverage * Trap_type +
                       Temperature + Relative_humidity +
                       Host_abundance + Prey_abundance +
                       factor(Month) +  
                       (1 | City / Location.Site) +
                       (1 | Mosquito_species), 
  family = nbinom2(),
  data = df,
  REML = TRUE
)

summary(m_final)

```


## 4. Model Diagnostics

```{r}
library(DHARMa)

# Simulate residuals
sim_res <- simulateResiduals(m_final)

# Plot residual diagnostics
plot(sim_res)

```
```{r}
testDispersion(sim_res)
```
```{r}
testZeroInflation(sim_res)
```
```{r}
ranef(m_final)
```
```{r}
library(ggeffects)
preds <- ggpredict(m_final, terms = c("Green_area_coverage", "Trap_type"))
plot(preds) + labs(y="Predicted Mosquito Abundance")

```
```{r}
pred_temp <- ggpredict(m_final, terms = "Temperature [all]")
plot(pred_temp) + 
  labs(title = "Predicted Mosquito Abundance", 
       y="Predicted Mosquito Abundance")

plot(pred_month) +
  labs(title = "Predicted Mosquito Abundance", 
       y = "Predicted Mosquito Abundance", 
       x = "Month") +
  scale_x_discrete(drop = FALSE) +   
  theme_minimal()
```



## 5. Model Interpretation


### Interpretation Summary

Green level is the only significant predictor:
Mosquito abundance increases strongly with greener environments, indicating that vegetated or park-like areas provide favorable breeding or resting habitats.
Trap type, temperature, humidity, and blue area coverage show no significant effect in this dataset, suggesting their influence is minor compared to vegetation cover.
The interaction between Green level and trap type is not significant, meaning both trap types respond similarly across green levels.


Mosquito abundance rises significantly with increasing urban green level, while other environmental factors (temperature, humidity, blue-area coverage) and trap types show negligible influence.
Random effects indicate modest variability among mosquito species and sampling sites, supporting the inclusion of these random terms.


```{r}
library(sjPlot)

plot_model(m_final, type = "est", 
           axis.lim = c(0.8, 1.4),        
           show.values = TRUE,             
           value.offset = 0.3,            
           value.size = 2.5,               
           dot.size = 2,                
           line.size = 0.7,
           vline.color = 'black') +              
  labs(title = "Incidence Rate Ratios (IRR)",
       x = "Incidence Rate Ratio") +
  theme_minimal()     



```


## 5. Visualizations

```{r}

ggplot(df, aes(x = factor(Green_level), y = Mosquito_abundance, fill = Trap_type)) +
  geom_boxplot(alpha = 0.7, outlier.size = 0.5) +
  theme_minimal(base_size = 14) +
  labs(
    title = "Observed Mosquito Count by Greenness Level and Trap Type",
    x = "Urban Greenness Level",
    y = "Observed Mosquito Abundance"
  ) +
  scale_fill_brewer(palette = "Set2")

```
Mosquito abundance increases consistently with greenness level across both trap types.
Although Light–CO₂ traps and Human–Odor–CO₂ traps show similar distributions, greener areas clearly host higher mosquito numbers.
This provides initial, descriptive evidence of an ecological gradient before modeling.



```{r}
num_df <- df %>% select(Temperature_2m, Relative_humidity, Blue_area_coverage, Green_area_coverage = Green_level)
corrplot(cor(num_df), method = "color", type = "upper", tl.col = "black")

```




```{r}

df$Green_level <- as.factor(df$Green_level)

# Refit model
model_abundance2 <- glmmTMB(
  Mosquito_abundance ~ Green_level * Trap_type + Temperature_2m +
    Relative_humidity + Blue_area_coverage +
    (1 | Location.Site) + (1 | Mosquito_species),
  family = nbinom2(),
  data = df
)

# Estimated marginal means
emm <- emmeans(model_abundance2, ~ Green_level * Trap_type, type = "response")

# Plot interaction
plot(emm, comparison = TRUE) +
  labs(
    title = "Predicted Mosquito Abundance by Green Level and Trap Type",
    x = "Urban Greenness Level",
    y = "Predicted Abundance (Response Scale)"
  )



```
The model predicts a strong increase in mosquito abundance with higher urban greenness, indicating vegetation-rich environments favor mosquito populations.
The effect of trap type is minimal — both traps capture similar numbers of mosquitoes across all vegetation levels.
Confidence intervals widen at higher greenness levels, suggesting greater variability in mosquito counts in green zones.






```{r}


# Extract random effects and standard deviations
ran_list <- ranef(model_abundance)$cond

# Convert to a tidy data frame
ran_df <- bind_rows(
  lapply(names(ran_list), function(g) {
    data.frame(
      Group = g,
      Level = rownames(ran_list[[g]]),
      Estimate = ran_list[[g]][, "(Intercept)"]
    )
  })
)

# Plot
ggplot(ran_df, aes(x = reorder(Level, Estimate), y = Estimate, color = Group)) +
  geom_point(size = 2) +
  coord_flip() +
  facet_wrap(~ Group, scales = "free_y") +
  theme_minimal(base_size = 13) +
  labs(
    title = "Random Effects by Site and Species",
    x = "Level (Site / Species)",
    y = "Deviation from Average Abundance"
  ) +
  theme(legend.position = "none",
        axis.text.y = element_text(angle = 15, vjust = 0.5),)


```



### Weather data visualitaon 

```{r}
ggplot(df, aes(x = Temperature_2m)) +
  geom_histogram(binwidth = 1, fill = "steelblue", color = "white", alpha = 0.8) +
  labs(
    title = "Temperature Distribution Across Sampling Sites",
    x = "Temperature (°C)",
    y = "Frequency"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold", size = 16),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

```
```{r}
ggplot(df, aes(x = City, y = Relative_humidity, fill = City)) +
  geom_boxplot(alpha = 0.7) +
  labs(
    title = "Variation in Relative Humidity by City",
    x = "City",
    y = "Relative Humidity (%)"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold", size = 16),
    legend.position = "none",
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

```

```{r}
df %>%
  ggplot(aes(x = Wind_speed_10m, fill = City)) +
  geom_density(alpha = 0.5) +
  labs(
    title = "Distribution of Wind Speed Across Cities",
    x = "Wind Speed (m/s)",
    y = "Density",
    fill = "City"
  ) +
  theme_minimal(base_size = 14)


```


```{r}

df %>%
  mutate(Month = month(Sampling_date, label = TRUE, abbr = TRUE)) %>%
  group_by(City, Month) %>%
  summarise(Mean_Temperature = mean(Temperature_2m, na.rm = TRUE)) %>%
  ggplot(aes(x = Month, y = Mean_Temperature, color = City, group = City)) +
  geom_line(size = 1.2) +
  geom_point(size = 2) +
  labs(
    title = "Average Monthly Temperature by City",
    x = "Month",
    y = "Temperature (°C)",
    color = "City"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(face = "bold", size = 16)
  )

```



```{r}

pred_inter <- ggpredict(
  model_abundance,
  terms = c("Green_level", "Trap_type"),
  type = "fixed",              # correct for your version
  bias_correction = TRUE
)

pred_df <- as.data.frame(pred_inter)


ggplot(pred_df, aes(
  x = factor(x),       # Greenness levels
  y = group,           # Trap types
  fill = predicted
)) +
  geom_tile(color = "white") +
  geom_text(aes(label = round(predicted, 1)), color = "black", size = 4) +
  scale_fill_gradient(low = "#fefefe", high = "#01665e") +
  labs(
    title = "Predicted Mosquito Count by Greenness Level and Trap Type",
    x = "Urban Greenness Level",
    y = "Trap Type",
    fill = "Predicted\nAbundance"
  ) +
  theme_minimal(base_size = 14)+
  theme(plot.title = element_text(size=12))


```
Mosquito abundance rises markedly with increasing urban greenness, regardless of the trap type used.
The model predicts roughly five times more mosquitoes in highly vegetated areas than in low-greenness zones, highlighting the ecological importance of vegetation in mosquito distribution.





```{r}
df_pred <- df %>%
  mutate(
    Predicted = predict(model_abundance, type = "response"),
    Observed = Mosquito_abundance
  )


ggplot(df_pred, aes(x = Predicted, y = Observed)) +
  geom_point(alpha = 0.4, size = 2) +
  geom_smooth(method = "lm", color = "#01665e", se = TRUE) +
  labs(
    title = "Model Fit: Predicted vs Observed Mosquito Abundance",
    x = "Predicted Abundance (Model)",
    y = "Observed Abundance (Data)"
  ) +
  theme_minimal(base_size = 14)

```




```{r}
df %>%
  group_by(Green_level, Mosquito_species) %>%
  summarise(Mean_abundance = mean(Mosquito_abundance)) %>%
  ggplot(aes(x = factor(Green_level), y = Mean_abundance, fill = Mosquito_species)) +
  geom_bar(stat = "identity", position = "fill") +
  labs(
    title = "Relative Mosquito Species Composition by Greenness Level",
    x = "Urban Greenness Level",
    y = "Proportion of Total Abundance"
  ) +
  theme_minimal(base_size = 14)

```


```{r}

df %>%
  mutate(Month = month(Sampling_date, label = TRUE, abbr = TRUE)) %>%
  group_by(Month) %>%
  summarise(Mean_abundance = mean(Mosquito_abundance)) %>%
  ggplot(aes(x = Month, y = Mean_abundance, group = 1)) +
  geom_line(size = 1.2, color = "#01665e") +
  geom_point(size = 2, color = "#01665e") +
  labs(
    title = "Seasonal Trend in Mosquito Abundance",
    x = "Month",
    y = "Average Abundance"
  ) +
  theme_minimal(base_size = 14)


```




```{r}
df %>%
  mutate(Month = month(Sampling_date, label = TRUE, abbr = TRUE)) %>%
  group_by(City, Month) %>%
  summarise(Mean_abundance = mean(Mosquito_abundance, na.rm = TRUE)) %>%
  ggplot(aes(x = Month, y = Mean_abundance, group = 1)) +
  geom_line(color = "#01665e", size = 1.2) +
  geom_point(color = "#01665e", size = 2) +
  facet_wrap(~ City, ncol = 2) +
  labs(
    title = "Seasonal Trends in Mosquito Abundance by City",
    x = "Month",
    y = "Average Mosquito Abundance"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold", size = 16),
    strip.text = element_text(size = 12),
    axis.text.x = element_text(angle = 90, vjust = 0.5)
  )

```




```{r}
df %>%
  mutate(Month = month(Sampling_date, label = TRUE, abbr = TRUE)) %>%
  group_by(City, Month) %>%
  summarise(Mean_abundance = mean(Mosquito_abundance, na.rm = TRUE)) %>%
  ggplot(aes(x = Month, y = Mean_abundance, color = City, group = City)) +
  geom_line(size = 1.2) +
  geom_point(size = 2) +
  labs(
    title = "Seasonal Trends in Mosquito Abundance by City",
    x = "Month",
    y = "Average Mosquito Abundance",
    color = "City"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold", size = 16),
    legend.position = "bottom"
  )


```


```{r}
df %>%
  mutate(Month = month(Sampling_date, label = TRUE, abbr = TRUE)) %>%
  group_by(Mosquito_species, Month) %>%
  summarise(Mean_abundance = mean(Mosquito_abundance, na.rm = TRUE), .groups = "drop") %>%
  ggplot(aes(x = Month, y = Mean_abundance, color = Mosquito_species, group = Mosquito_species)) +
  geom_point(size = 2) +
  geom_smooth(se = FALSE, linewidth = 1.2, method = "loess") +
  labs(
    title = "Seasonal Trends in Mosquito Abundance by Species",
    x = "Month",
    y = "Average Mosquito Abundance",
    color = "Species"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold", size = 16),
    legend.position = "bottom"
  )

```



```{r}

df$Date <- as.Date(df$Sampling_date, format = "%Y-%m-%d")

# Create the monthly trend plot
df %>%
  mutate(Month = month(Date, label = TRUE, abbr = TRUE)) %>%
  group_by(Mosquito_species, Month) %>%
  summarise(Mean_abundance = mean(Mosquito_abundance, na.rm = TRUE), .groups = "drop") %>%
  ggplot(aes(x = Month, y = Mean_abundance, color = Mosquito_species, group = Mosquito_species)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 2) +
  labs(
    title = "Monthly Trends in Mosquito Abundance by Species",
    x = "Month",
    y = "Average Mosquito Abundance",
    color = "Species"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold", size = 16),
    legend.position = "bottom"
  )

```



```{r}

# Create faceted plot by species
df %>%
  mutate(Month = month(Date, label = TRUE, abbr = TRUE)) %>%
  group_by(Mosquito_species, Month) %>%
  summarise(Mean_abundance = mean(Mosquito_abundance, na.rm = TRUE), .groups = "drop") %>%
  ggplot(aes(x = Month, y = Mean_abundance, group = 1)) +
  geom_line(color = "#2C7BB6", linewidth = 1.2) +
  geom_point(color = "#2C7BB6", size = 2) +
  facet_wrap(~ Mosquito_species, scales = "free_y") +
  labs(
    title = "Monthly Trends in Mosquito Abundance by Species",
    x = "Month",
    y = "Average Mosquito Abundance"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold", size = 16, hjust = 0.5),
    strip.text = element_text(face = "bold"),
    axis.text.x = element_text(angle = 90, vjust = 0.5),
    legend.position = "none"
  )

```




```{r}
ggplot(df, aes(x = Trap_type, y = Mosquito_abundance, fill = Trap_type)) +
  geom_boxplot(outlier.alpha = 0.2) +
  facet_wrap(~ City) +
  scale_fill_brewer(palette = "Set2") +
  labs(
    title = "Distribution of Mosquito Abundance by Trap Type and City",
    x = "Trap Type", y = "Mosquito Abundance"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

```




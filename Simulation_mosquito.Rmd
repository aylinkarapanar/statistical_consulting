---
title: "Simulation"
author: "Atakan_Akgun"
date: "`r Sys.Date()`"
output: pdf_document
---


```{r}
library(dplyr)
library(tidyr)
library(lubridate)
library(writexl)
library(purrr)
set.seed(1234)
```

```{r}
Country <- c("Netherlands", "France", "Spain")
City <- c("Utrecht", "Nijmegen", "Montpellier", "Barcelona")
Sites <- paste0("Site_", 1:9)
Trap_type <- c("Light_CO2", "HumanOdor_CO2")
Mosquito_species <- c("Culex quinquefasciatus", "Aedes aegypti",
                      "Aedes albopictus", "Anopheles gambiae", "Culex pipiens")
Sampling_dates <- seq.Date(as.Date("2024-01-01"), as.Date("2024-12-31"), by = "month")


```

```{r}
design <- expand.grid(
  City = City,
  Site = Sites,
  Sampling_date = Sampling_dates,
  stringsAsFactors = FALSE
)

design$Country <- ifelse(design$City %in% c("Utrecht", "Nijmegen"), "Netherlands",
                         ifelse(design$City == "Montpellier", "France", "Spain"))
```


```{r}
#environmental variables
design$Green_level <- sample(1:3, nrow(design), replace = TRUE)
design$Green_area_coverage <- round(runif(nrow(design), 5, 80), 2)
design$Blue_area_coverage <- round(runif(nrow(design), 2, 50), 2)
design$Temperature <- round(rnorm(nrow(design), mean = 22, sd = 5), 2)
design$Relative_humidity <- round(runif(nrow(design), 40, 90), 2)
design$Wind_speed_10m <- round(runif(nrow(design), 0.5, 6.5), 2)

```

```{r}
# Randomly assign trap types 
design$Trap_type <- sample(Trap_type, nrow(design), replace = TRUE)
```

```{r}
# Randomly assign which species were caught per site-date 
# Each site-date will have between 2 and 5 species observed
library(dplyr)

df <- design %>%
  mutate(n_species = sample(2:5, n(), replace = TRUE)) %>%
  rowwise() %>%
  mutate(
    Observed_species = list(sample(Mosquito_species, n_species))
  ) %>%
  ungroup() %>%
  select(-n_species)


# Expand the dataset so each species has its own row
df <- df %>%
  tidyr::unnest(Observed_species) %>%
  rename(Mosquito_species = Observed_species)


```

```{r}
# mosquito abundance
df$Mosquito_abundance <- rpois(
  nrow(df),
  lambda = 10 + df$Green_level * 3 +
    ifelse(df$Trap_type == "Light_CO2", 5, 0) +
    rnorm(nrow(df), 0, 2)
)
df$Mosquito_abundance[df$Mosquito_abundance < 0] <- 0
```


```{r}
# Calculate biodiversity index per site-date
df <- df %>%
  group_by(City, Site, Sampling_date) %>%
  mutate(
    p_i = Mosquito_abundance / sum(Mosquito_abundance, na.rm = TRUE),
    Biodiversity_index = -sum(p_i * log(p_i + 1e-8), na.rm = TRUE)
  ) %>%
  ungroup() %>%
  select(-p_i)
```


```{r}

# --- Save file ---------------------------------------------------------------
if (!requireNamespace("writexl", quietly = TRUE)) install.packages("writexl")
writexl::write_xlsx(df, "Mock_Mosquito_MixedEffects_Dataset.xlsx")

```



#### Not done Realistic mock data

```{r}
# generate_mock_mosquito_data.R
# -----------------------------------------------------------------------------
# Script to simulate a mock mosquito dataset matching the structure:
# Columns:
# Country, City, Location/Site, Sampling_date, Trap_type, Green_level,
# Green_area_coverage, Blue_area_coverage, Temperature, Relative_humidity,
# Wind_speed_10m, Mosquito_species, Mosquito_abundance, Biodiversity_index
#
# Produces ~2160 rows: 4 cities x 9 sites x 12 months x 5 species.
# -----------------------------------------------------------------------------

set.seed(2025)

# --- Packages ----------------------------------------------------------------
if (!requireNamespace("writexl", quietly = TRUE)) {
  install.packages("writexl")
}
library(dplyr)
library(lubridate)
library(writexl)

# --- Study design ------------------------------------------------------------
countries <- c("Netherlands", "France", "Spain")
# Cities according to your study (Netherlands has two cities)
city_list <- list(
  Netherlands = c("Utrecht", "Nijmegen"),
  France = c("Montpellier"),
  Spain = c("Barcelona")
)

# Flatten cities to a vector and keep country mapping
cities <- unlist(city_list)
city_country_map <- data.frame(
  City = cities,
  Country = unlist(lapply(names(city_list), function(cty) rep(cty, length(city_list[[cty]])))),
  stringsAsFactors = FALSE
)
# Sites per city
sites_per_city <- 9

# Sampling dates: 12 monthly samples (one year)
start_date <- as.Date("2025-03-15")
sampling_dates <- start_date %m+% months(0:11)   # 12 months

# Trap types and mosquito species
trap_types <- c("Light_CO2", "HumanOdor_CO2")
mosquito_species <- c("Aedes albopictus", "Culex pipiens", "Anopheles gambiae",
                      "Aedes aegypti", "Culex quinquefasciatus")

# Greenness levels (1..4) and mapping to percent mean
green_levels <- 1:4

# --- Build the sampling grid -------------------------------------------------
rows <- list()
for (i in seq_len(nrow(city_country_map))) {
  city <- city_country_map$City[i]
  country <- city_country_map$Country[i]
  
  for (site in 1:sites_per_city) {
    # Assign a base greenness level per site (random but balanced across levels)
    green_level_site <- sample(green_levels, 1)
    # green percent drawn around 25*level with some SD
    green_pct_site <- pmin(100, pmax(0, rnorm(1, mean = 25 * green_level_site, sd = 6)))
    # blue coverage inversely related to greenness but with noise
    blue_pct_site <- pmin(100, pmax(0, rnorm(1, mean = 10 * (5 - green_level_site), sd = 7)))
    
    for (sd in sampling_dates) {
      # add a small random day jitter so dates look realistic (Â±7 days)
      sampling_date <- sd + sample(-7:7, 1)
      
      # city-level temperature baseline (approx)
      temp_base <- switch(city,
                          "Barcelona" = 25,
                          "Montpellier" = 23,
                          "Utrecht" = 17,
                          "Nijmegen" = 18,
                          20)
      # simulate temperature with seasonal effect: warmer in summer months
      month_factor <- sin(2 * pi * (month(sampling_date) / 12)) # -1..1
      temperature <- round(rnorm(1, mean = temp_base + 6 * month_factor - 0.5 * green_level_site, sd = 2.5), 2)
      
      # humidity inversely related to temperature a bit, with noise
      relative_humidity <- round(pmin(100, pmax(20, rnorm(1, mean = 70 - 0.6 * (temperature - 15) + green_level_site*1.5, sd = 7))), 2)
      
      # wind speed random
      wind_speed <- round(runif(1, 0.2, 6.5), 2)
      
      # biodiversity index: loosely linked to green pct
      biodiversity_index <- round(pmin(3, pmax(0.3, rnorm(1, mean = 0.02 * green_pct_site + 0.8, sd = 0.35))), 2)
      
      # choose trap type for this sample (random)
      trap_type <- sample(trap_types, 1)
      
      # For each species create one row (option A: species-level rows)
      for (sp in mosquito_species) {
        # species-specific relative abundance multiplier
        sp_mult <- switch(sp,
                          "Aedes albopictus" = 1.25,
                          "Culex pipiens" = 1.00,
                          "Anopheles gambiae" = 0.85,
                          "Aedes aegypti" = 1.10,
                          "Culex quinquefasciatus" = 0.95,
                          1.0)
        # trap efficiency multiplier
        trap_mult <- ifelse(trap_type == "Light_CO2", 1.0, 1.05)
        
        # seasonal multiplier (higher in summer months)
        season_mult <- pmax(0.2, 1 + 0.9 * month_factor)  # ~0.1 to 1.9
        
        # Base mean abundance depends on greenness, species, trap, season, temp
        base_mu <- (6 * green_level_site + 1.2 * (green_pct_site / 25)) * sp_mult * trap_mult * season_mult + 0.15 * (temperature - 15)
        base_mu <- pmax(0.5, base_mu)  # ensure positive
        
        # Add site-level random noise to mean
        site_noise <- rnorm(1, mean = 1, sd = 0.12)
        mu <- base_mu * site_noise
        
        # Simulate counts with overdispersion (negative binomial)
        # size parameter controls overdispersion; smaller -> more overdispersion
        abundance <- rnbinom(1, mu = mu, size = 1.8)
        
        rows[[length(rows) + 1]] <- data.frame(
          Country = country,
          City = city,
          LocationSite = site,          # temporary name; will rename to 'Location/Site'
          Sampling_date = as.character(sampling_date),  # keep as character for exact file-like format
          Trap_type = trap_type,
          Green_level = green_level_site,
          Green_area_coverage = round(green_pct_site + rnorm(1, 0, 2), 2),  # small noise
          Blue_area_coverage = round(blue_pct_site + rnorm(1, 0, 2), 2),
          Temperature = temperature,
          Relative_humidity = relative_humidity,
          Wind_speed_10m = wind_speed,
          Mosquito_species = sp,
          Mosquito_abundance = as.integer(abundance),
          Biodiversity_index = biodiversity_index,
          stringsAsFactors = FALSE
        )
      } # species loop
    } # date loop
  } # site loop
} # city loop

# Combine into a single data frame
df_sim <- bind_rows(rows)

# Rename LocationSite -> Location/Site to match exact requested column name
names(df_sim)[names(df_sim) == "LocationSite"] <- "Location/Site"

# Convert Sampling_date to YYYY-MM-DD string (consistent formatting)
df_sim$Sampling_date <- as.character(as.Date(df_sim$Sampling_date))

# Optional: shuffle rows to mimic real data ordering
df_sim <- df_sim[sample(seq_len(nrow(df_sim))), ]

# Reorder columns to exactly the requested order
df_sim <- df_sim %>%
  select(Country, City, `Location/Site`, Sampling_date, Trap_type, Green_level,
         Green_area_coverage, Blue_area_coverage, Temperature, Relative_humidity,
         Wind_speed_10m, Mosquito_species, Mosquito_abundance, Biodiversity_index)

# Quick sanity checks
cat("Generated rows:", nrow(df_sim), "\n")
cat("Unique cities:", paste(unique(df_sim$City), collapse = ", "), "\n")
cat("Unique species:", paste(unique(df_sim$Mosquito_species), collapse = ", "), "\n")

# Write outputs
out_csv <- "Mock_Mosquito_MixedEffects_Dataset_fromR.csv"
out_xlsx <- "Mock_Mosquito_MixedEffects_Dataset_fromR.xlsx"

write.csv(df_sim, out_csv, row.names = FALSE)
writexl::write_xlsx(df_sim, out_xlsx)

cat("Saved CSV to", out_csv, "\n")
cat("Saved XLSX to", out_xlsx, "\n")

```


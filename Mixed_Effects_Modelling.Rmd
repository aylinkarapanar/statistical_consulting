---
title: "Model Spesifications"
author: "Atakan_Akgun, Aylin Karapanar"
date: "`r Sys.Date()`"
output: html_notebook
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
# Essential libraries
library(corrplot)
library(ggeffects)
library(ggplot2)
library(DHARMa)
library(glmmTMB)
library(dplyr)
library(lubridate)
library(emmeans)
library(tidyverse)
library(performance)
library(sjPlot)
```

## 1. Data Import and Preparation

```{r}
df <- read.csv("./Simulated Data/Mock_Mosquito_MixedEffects_w_slopes_Dataset.csv")
df$Trap_type = factor(df$Trap_type)
df$Mosquito_species = factor(df$Mosquito_species)

```

```{r}
head(df)
```

## 2. Model Specification

### Defining Random Effects

We start by first defining the random effects part. There are two random effects defined in our model, one for the nested structure in our data and the other for the mosquito species. By defining random intercepts in m1 model, we assume that different cities have different baseline abundance levels, different sites within the same city have different baseline abundance, and different mosquito species have different baseline abundance levels. However, the slopes remain consistent meaning all cities and species respond to green coverage the same way.


```{r}
m1_baseline <- glmmTMB(
  Mosquito_abundance ~ Green_area_coverage * Trap_type +
                       Temperature * Relative_humidity +
                       Host_abundance * Predator_abundance +
                       Blue_area_coverage +
                       factor(Month) +
                       (1 | City / Location.Site) +      # nested random effects
                       (1 | Mosquito_species),           # random intercept by species
  family = nbinom2(),
  data = df,
  REML = TRUE
)

summary(m1_baseline)

baseline_aic <- AIC(m1_baseline)
cat("Baseline AIC:", baseline_aic, "\n")
```

In the second model, we consider random slopes for green levels in the cities, meaning that the effect of urban green differs per city.

```{r}
m2_city_green <- glmmTMB(
  Mosquito_abundance ~ Green_area_coverage * Trap_type +
                       Temperature * Relative_humidity +
                       Host_abundance * Predator_abundance +
                       Blue_area_coverage +
                       factor(Month) +
                      (1 + Green_area_coverage | City) +          # City random intercept + slope
                      (1 | Location.Site:City) +        
                      (1 | Mosquito_species),
  family = nbinom2(),
  data = df,
  REML =TRUE
)


# Check convergence
check_convergence(m2_city_green)
m2_city_green$sdr$pdHess

cat("AIC difference:", AIC(m2_city_green) - baseline_aic, "\n")

lrt_m2 <- anova(m1_baseline, m2_city_green)$Chisq[2]
lrt_m2
p_m2 <- 0.5 * pchisq(lrt_m2, df = 2, lower.tail = FALSE) + 
           0.5 * pchisq(lrt_m2, df = 1, lower.tail = FALSE)
cat("p-value:", p_m2, "\n")

```

AIC difference is negative and the $H_0: \text{Cities do not differ in how urban green level affects mosquito abundance}$ is rejected (p<0.05), the random slope of urban green level is significant.


```{r}
m3_city_temp <- glmmTMB(
  Mosquito_abundance ~ Green_area_coverage * Trap_type +
                       Temperature * Relative_humidity +
                       Host_abundance * Predator_abundance +
                       Blue_area_coverage +
                       factor(Month) +
                      (1 + Temperature | City) +      
                      (1 | Location.Site:City) +        
                      (1 | Mosquito_species),
  family = nbinom2(),
  data = df,
  REML = TRUE
)

# Check convergence
check_convergence(m3_city_temp)
m3_city_temp$sdr$pdHess

cat("AIC difference:", AIC(m3_city_temp) - baseline_aic, "\n")

lrt_m3 <- anova(m1_baseline, m3_city_temp)$Chisq[2]
lrt_m3
p_m3 <- 0.5 * pchisq(lrt_m3, df = 2, lower.tail = FALSE) +
        0.5 * pchisq(lrt_m3, df = 1, lower.tail = FALSE)
cat("p-value for Temp slope:", p_m3, "\n")
```
AIC difference is positive and the $H_0: \text{Cities do not differ in how temperature affects mosquito abundance}$ is retained (p>0.05), the random slope of temperature is not significant.

```{r}
m4_both_slopes <- glmmTMB(
  Mosquito_abundance ~ Green_area_coverage * Trap_type +
                       Temperature * Relative_humidity +
                       Host_abundance * Predator_abundance +
                       Blue_area_coverage +
                       factor(Month) +
                       (1 + Green_area_coverage + Temperature | City) +
                       (1 | Location.Site:City) +
                       (1 | Mosquito_species),
  family = nbinom2(),
  data = df,
  REML = TRUE
)

# Check convergence
check_convergence(m4_both_slopes)
m4_both_slopes$sdr$pdHess

summary(m4_both_slopes)
# Compare m2 -> m4 (does adding temperature slope to m2 improve fit?)
lrt_m2_m4 <- anova(m2_city_green, m4_both_slopes)$Chisq[2]
cat("LRT stat (m2 -> m4):", lrt_m2_m4, "\n")
p_m2_m4 <- 0.5 * pchisq(lrt_m2_m4, df = 2, lower.tail = FALSE) + 
           0.5 * pchisq(lrt_m2_m4, df = 1, lower.tail = FALSE)
cat("p-value (m2 -> m4):", p_m2_m4, "\n")

# Compare m3 -> m4 (does adding Green slope to m3 improve fit?)
lrt_m3_m4 <- anova(m3_city_temp, m4_both_slopes)$Chisq[2]
cat("LRT stat (m3 -> m4):", lrt_m3_m4, "\n")
p_m3_m4 <- 0.5 * pchisq(lrt_m3_m4, df = 2, lower.tail = FALSE) + 
           0.5 * pchisq(lrt_m3_m4, df = 1, lower.tail = FALSE)
cat("p-value (m3 -> m4):", p_m3_m4, "\n")

# Compare all models by AIC 
models <- list(m1_baseline = m1_baseline, m2 = m2_city_green, m3 = m3_city_temp, m4 = m4_both_slopes)
aic_tab <- data.frame(
  model = names(models),
  AIC = sapply(models, AIC),
  pdHess = sapply(models, function(m) { if (is.null(m$sdr)) NA else m$sdr$pdHess })
)
aic_tab <- aic_tab %>% arrange(AIC)
print(aic_tab)
```

Across the models tested, the lowest AIC value was tested was achieved by model 2, for the remainder of the model selection procedure we will use the random effects defined in model 2. Now, we will focus on getting a more parsimonious fixed effects part by removing interaction terms in a step wise manner.


```{r}
m_full <- glmmTMB(
  Mosquito_abundance ~ Green_area_coverage * Trap_type +
                       Temperature * Relative_humidity +
                       Host_abundance * Predator_abundance +
                       Blue_area_coverage +
                       factor(Month) +
                       (1 + Green_area_coverage | City) +          # City random intercept + slope
                      (1 | Location.Site:City) +        
                      (1 | Mosquito_species),
  family = nbinom2(),
  data = df,
  REML = FALSE  # ML for fixed effects comparison
)

summary(m_full)
```

We start by removing the least significant interaction term which is Temperature:Relative_humidity . 
```{r}
m_wo_temp_hum <- glmmTMB(
  Mosquito_abundance ~ Green_area_coverage * Trap_type +
                       Temperature + Relative_humidity +
                       Host_abundance * Predator_abundance +
                       Blue_area_coverage +
                       factor(Month) +
                       (1 + Green_area_coverage | City) +          # City random intercept + slope
                      (1 | Location.Site:City) +        
                      (1 | Mosquito_species),
  family = nbinom2(),
  data = df,
  REML = FALSE  # ML for fixed effects comparison
)

summary(m_wo_temp_hum)
anova(m_full, m_wo_temp_hum)
```
Removing the Temperature:Relative_humidity interaction does not significantly worsen model fit, then the interaction is not needed. We move on to the next interaction.

```{r}
m_wo_host_pre <- glmmTMB(
  Mosquito_abundance ~ Green_area_coverage * Trap_type +
                       Temperature + Relative_humidity +
                       Host_abundance + Predator_abundance +
                       Blue_area_coverage +
                       factor(Month) +
                       (1 + Green_area_coverage | City) +          # City random intercept + slope
                      (1 | Location.Site:City) +        
                      (1 | Mosquito_species),
  family = nbinom2(),
  data = df,
  REML = FALSE  # ML for fixed effects comparison
)

summary(m_wo_host_pre)
anova(m_wo_temp_hum, m_wo_host_pre)
```

Removing the Host_abundance:Predator_abundance  interaction does not worsen model fit, the interaction should be removed. The remaining interaction is significant, therefore we move to the main effects. The least significant one is Predator_abundance. 

```{r}
m_wo_pre <- glmmTMB(
  Mosquito_abundance ~ Green_area_coverage * Trap_type +
                       Temperature + Relative_humidity +
                       Host_abundance + 
                       Blue_area_coverage + 
                       factor(Month) +  
                       (1 + Green_area_coverage | City) +          # City random intercept + slope
                      (1 | Location.Site:City) +        
                      (1 | Mosquito_species),
  family = nbinom2(),
  data = df,
  REML = FALSE
)

summary(m_wo_pre)
anova(m_wo_host_pre, m_wo_pre)
```
Removal of predator abundance did not worsen the model, we remove it and move on the next main effect.

```{r}
m_wo_blue <- glmmTMB(
  Mosquito_abundance ~ Green_area_coverage * Trap_type +
                       Temperature + Relative_humidity +
                       Host_abundance + 
                       factor(Month) +  
                       (1 + Green_area_coverage | City) +          # City random intercept + slope
                      (1 | Location.Site:City) +        
                      (1 | Mosquito_species),
  family = nbinom2(),
  data = df,
  REML = FALSE
)

summary(m_wo_blue)
anova(m_wo_pre, m_wo_blue)
```

Removal of blue zone coverage did not worsen the model, we remove it and move on the next main effect. Month shows mixed significance, so we will try removing it and compare the model fits.

```{r}
m_wo_month <- glmmTMB(
  Mosquito_abundance ~ Green_area_coverage * Trap_type +
                       Temperature + Relative_humidity +
                       Host_abundance + 
                       (1 + Green_area_coverage | City) +          # City random intercept + slope
                      (1 | Location.Site:City) +        
                      (1 | Mosquito_species),
  family = nbinom2(),
  data = df,
  REML = FALSE
)

anova(m_wo_blue, m_wo_month)
```
Removing the month did not worsen the fit, so our final model is:

```{r}
m_final <- glmmTMB(
  Mosquito_abundance ~ Green_area_coverage * Trap_type +
                       Temperature + Relative_humidity +
                       Host_abundance + 
                       (1 + Green_area_coverage | City) +          # City random intercept + slope
                      (1 | Location.Site:City) +        
                      (1 | Mosquito_species), 
  family = nbinom2(),
  data = df,
  REML = TRUE
)

summary(m_final)

```


## 4. Model Diagnostics

```{r}
# Simulate residuals
sim_res <- simulateResiduals(m_final)

# Save QQ plot
png("./Simulated Data/dharma_qq_plot.png", width = 1200, height = 1200, res = 300)
plotQQunif(sim_res)
dev.off()

# Save Residuals vs Predicted
png("./Simulated Data/dharma_residuals_vs_predicted.png", width = 1200, height = 1200, res = 300)
plotResiduals(sim_res)
dev.off()

# Save Dispersion test separately
png("./Simulated Data/dharma_dispersion_test.png", width = 1200, height = 1200, res = 300)
testDispersion(sim_res, plot = TRUE)
dev.off()

# Save Zero-inflation test separately
png("./Simulated Data/dharma_zeroinflation_test.png", width = 1200, height = 1200, res = 300)
testZeroInflation(sim_res, plot = TRUE)
dev.off()

plot(sim_res)
testDispersion(sim_res)
testZeroInflation(sim_res)

```
```{r}
testDispersion(sim_res)
```
```{r}
testZeroInflation(sim_res)
```
```{r}
ranef(m_final)
```


## 5. Model Interpretation
```{r}
preds <- ggpredict(m_final, terms = c("Green_area_coverage", "Trap_type"))
plot(preds) + labs(y="Predicted Mosquito Abundance")

```

```{r}
pred_temp <- ggpredict(m_final, terms = "Temperature [all]")
plot(pred_temp) + 
  labs(title = "Predicted Mosquito Abundance", 
       y="Predicted Mosquito Abundance")

pred_host <- ggpredict(m_final, terms = "Host_abundance")
plot(pred_host) +
  labs(x="Host abundance", y="Predicted mosquitoes") +
  theme_minimal()


```


```{r}
re_plots = sjPlot::plot_model(m_final, type = "re",
                              show.values = TRUE, 
                              value.offset = 0.3, 
                              value.size = 2.5, 
                              dot.size = 2,                
                              line.size = 0.7,
                              vline.color = 'black') 

re_plots[[1]] + theme_minimal()
re_plots[[3]] + theme_minimal()
```

```{r}
p <- plot_model(m_final, type = "est", transform = "exp", 
                axis.lim = c(0.8, 1.4),        
                show.values = TRUE,             
                value.offset = 0.3,            
                value.size = 2.5,               
                dot.size = 2,                
                line.size = 0.7,
                vline.color = 'black') +              
  labs(title = "Incidence Rate Ratios (IRR)",
       x = "Incidence Rate Ratio") +
  theme_minimal()

p + scale_color_manual(values = c("steelblue"))   

```
```{r}
icc_values <- performance::icc(m_final, tolerance = 1e-6)
icc_values

```






